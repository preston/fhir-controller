<!-- <span id='fire-icon' class="bi bi-fire">  </span> -->
<div id="loader" class="container-fluid">
    <div class="row mt-4 p-4">
        <div class="col-sm-8">
            <h4>Instructions</h4>
            <markdown [data]="loaderService.currentConfiguration?.instructions"></markdown>


        </div>
        <div class="col-sm-4">
            <section>
                <h4>Links</h4>
                <ul class="list-group">
                    @for (l of loaderService.currentConfiguration?.links || []; track l.url) {
                      <li class="list-group-item">
                        <a [href]="l.url" target="_blank">{{l.name}}</a>
                      </li>
                    }
                </ul>
            </section>
        </div>
    </div>
    <div class="row my-4 p-4">
        <div class="col-sm-7">
            <h4>Data Controls
                <button class="me-2 btn btn-sm btn-outline-secondary" role="button" (click)="reloadStackConfiguration()"
                    [disabled]="state == 'loading'"><span class="bi bi-arrow-clockwise"></span>
                    Reload Form</button>
            </h4>
            <div class="input-group input-group-md">
                <span class="input-group-text"> <span class="bi bi-fire"></span>&nbsp; FHIR Base URL</span>
                <input type="text" class="form-control" [(ngModel)]="fhirBaseUrl" />
            </div>
            @if (files_to_load.length == 0) {
              <div>
                <span class="badge bg-warning">No data files have been configured to load. Please update the controller
                    configuration file if you'd like to load FHIR bundles.</span>
              </div>
            }
            @if (files_to_load.length > 0) {
              <div class="">
                <h4 class="mt-4">Files
                </h4>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><span class="bi bi-diagram-3"></span>&nbsp;Scenario</span>
                            <select class="form-control" [(ngModel)]="selectedScenario" (change)="onScenarioChange()">
                                @for (scenario of availableScenarios; track scenario.id) {
                                  <option [value]="scenario.id">
                                    {{scenario.name}}
                                  </option>
                                }
                            </select>
                        </div>
                        <small class="text-muted">{{selectedScenarioDescription}}</small>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">

                        <button role="button" class="btn btn-md btn-outline-secondary" (click)="toggleSelected()"> <span
                                class="bi bi-check-square"></span> Toggle Selections</button>

                        <button class="btn btn-md btn-success" role="button" (click)="load()"
                            [disabled]="state == 'loading'"><span class="bi bi-save"> Load Selected File
                                Sequence</span></button>
                        @if (development) {
                          <button class="btn btn-md btn-secondary" role="button"
                            (click)="test()"><span class="bi bi-chat"></span>
                            Test</button>
                        }
                            </div>
                    </div>
                </div>

                <div class="my-2 list-group">
                    <!-- <span class="fw-lighter">The following data files will be loading in the following sequence. </span> -->
                    @for (f of filteredFiles; track f.file) {
                      <span class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">
                                <div class="form-check form-switch form-check-secondary">
                                    @if (f.loader === loaderTypes().CQL_AS_FHIR_LIBRARY) {
                                      <span class="bi bi-code"></span>
                                    }
                                    @if (f.loader === loaderTypes().FHIR_BUNDLE || !f.loader) {
                                      <span class="bi bi-fire"></span>
                                    }
                                    <input class="form-check-input me-1" role="checkbox" [(ngModel)]="f.load"
                                        type="checkbox" />
                                    &nbsp;<a role="button" [href]="f.file" target="_blank">{{f.name}}</a>
                                </div>
                            </h5>

                            <small>{{f.type}}
                                <br>
                                <i>Priority: {{f.priority}}</i>

                            </small>
                        </div>
                        <p class="mb-1">{{f.description}}</p>
                        <small>{{f.file}}</small>
                        @if(f.evaluate?.id != null)
                        { <br>
                        <div class="input-group">
                            @if(f.loader === loaderTypes().CQL_AS_FHIR_LIBRARY) {
                            <div class="input-group-text"><span class="bi bi-people"></span>&nbsp;Subject</div>
                            <select name="subject" id="evaluateSubject" [(ngModel)]="evaluateSubject">
                                @for (s of f.evaluate?.subjects || []; track s.id || s.name) {
                                  <option>{{s.name}}</option>
                                }
                            </select>
                            @if(this.evaluateSubject) {
                            <button class="btn btn-md btn-success" (click)="evaluateCql(f)"><span
                                    class="bi bi-braces"></span> Evaluate</button>
                            }
                            } @else if (f.loader === loaderTypes().FHIR_BUNDLE) {
                            }
                        </div>
                        }
                        <!-- <span class="badge text-bg-primary rounded-pill">14</span> -->
                      </span>
                    }
                </div>
              </div>
            }

        </div>
        <div class="col-sm-5">

            <section class="">
                <h4>Server Utilities</h4>
                <!-- {{loaderService.currentConfiguration?.driver}}
                {{loaderService.driver?.code}} -->
                <div class="input-group">
                    <span class="input-group-text"><i class="bi-fire"></i>&nbsp;Driver</span>
                    <select class="form-control" [(ngModel)]="selectedDriver">
                        <option [value]="driverTypes().Generic"
                            [selected]="loaderService.driver?.code == driverTypes().Generic">Generic</option>
                        <option [value]="driverTypes().Hapi"
                            [selected]="loaderService.driver?.code == driverTypes().Hapi">HAPI FHIR</option>
                        <option [value]="driverTypes().WildFHIR"
                            [selected]="loaderService.driver?.code == driverTypes().WildFHIR">Aegis WildFHIR</option>
                        <option [value]="driverTypes().FHIRCandle"
                            [selected]="loaderService.driver?.code == driverTypes().FHIRCandle">FHIR Candle</option>
                    </select>
                </div>
                <!-- <span class="fw-lighter">Unimplemented or
                    incompatible functions of <b>{{loaderService.driver?.name}}</b> will be disabled.</span> -->
                <br />
                <button class="btn btn-md btn-warning" role="button" (click)="resetServerData()"
                    [disabled]="loaderService.driver?.supports_reset() == false || state == 'loading'"><span
                        class="bi bi-trash">
                        Permanently Reset Server Data</span></button>
            </section>

            <section class="mt-4 pt-4">
                <h4>Controller Messages</h4>
                <span class="fw-lighter">Your activity history.</span>
                <ul class="list-group">
                    @for (m of messages; track m.date || $index) {
                      <li class="list-group-item" [class]="'list-group-item-' + m.type">
                        <div class="d-flex w-100 justify-content-between">
                            {{m.body}}
                            <small> {{m.date | amTimeAgo}}</small>
                        </div>
                      </li>
                    }
                </ul>
            </section>

        </div>
    </div>
</div>