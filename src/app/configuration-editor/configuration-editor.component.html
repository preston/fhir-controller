<style>
  /* Fix for form-floating select dropdown text cropping */
  .form-floating .form-select {
    z-index: 2;
  }
  
  .form-floating .form-select:focus {
    z-index: 3;
  }
  
  .form-floating .form-select:not(:placeholder-shown) {
    z-index: 3;
  }
  
  /* Ensure dropdown options appear above the floating label */
  .form-floating .form-select option {
    z-index: 4;
  }
  
  /* Additional fix for better dropdown visibility */
  .form-floating .form-select:focus ~ label {
    z-index: 1;
  }
</style>

<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <!-- Header Section -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="mb-1" [class.has-unsaved-changes]="hasUnsavedChanges">
            <i class="bi bi-gear me-2"></i>
            Configuration Editor
            <span *ngIf="isNewConfiguration" class="badge bg-success ms-2">New</span>
          </h2>
          <small *ngIf="!isNewConfiguration && currentConfiguration" class="text-muted">
            {{ currentConfiguration.title }}
          </small>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" (click)="createNewConfiguration()">
            <i class="bi bi-plus me-1"></i>
            New
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" (click)="resetForm()">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Reset
          </button>
          <button type="button" class="btn btn-success btn-sm" (click)="saveConfiguration()">
            <i class="bi bi-check me-1"></i>
            Apply
          </button>
          <button type="button" class="btn btn-outline-primary btn-sm" (click)="downloadConfiguration()">
            <i class="bi bi-download me-1"></i>
            Download
          </button>
        </div>
      </div>
          <!-- Validation Errors -->
          <div *ngIf="validationErrors.length > 0" class="alert alert-danger" role="alert">
            <h6 class="alert-heading">
              <i class="bi bi-exclamation-triangle me-1"></i>
              Validation Errors
            </h6>
            <ul class="mb-0">
              <li *ngFor="let error of validationErrors">{{ error }}</li>
            </ul>
          </div>

          <!-- Configuration Form -->
          <form *ngIf="configurationForm" [formGroup]="configurationForm" (ngSubmit)="saveConfiguration()">
            
            <!-- Basic Configuration Section -->
            <div class="row mb-3">
              <div class="col-12">
                <h5 class="text-muted mb-3">Basic Configuration</h5>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <input 
                    type="text" 
                    class="form-control" 
                    id="title"
                    formControlName="title"
                    [class.is-invalid]="configurationForm.get('title')?.invalid && configurationForm.get('title')?.touched"
                    placeholder="Enter configuration title">
                  <label for="title">Title <span class="text-danger">*</span></label>
                </div>
                <div *ngIf="configurationForm.get('title')?.invalid && configurationForm.get('title')?.touched" class="invalid-feedback">
                  Title is required and must be at least 1 character long.
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <select 
                    class="form-select" 
                    id="driver"
                    formControlName="driver"
                    [class.is-invalid]="configurationForm.get('driver')?.invalid && configurationForm.get('driver')?.touched">
                    <option value="" disabled>Select driver type</option>
                    <option [value]="DriverType.Generic">Generic</option>
                    <option [value]="DriverType.Hapi">HAPI FHIR</option>
                    <option [value]="DriverType.WildFHIR">WildFHIR</option>
                    <option [value]="DriverType.FHIRCandle">FHIR Candle</option>
                  </select>
                  <label for="driver">Driver Type <span class="text-danger">*</span></label>
                </div>
                <div *ngIf="configurationForm.get('driver')?.invalid && configurationForm.get('driver')?.touched" class="invalid-feedback">
                  Please select a driver type.
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-12">
                <div class="form-floating">
                  <input 
                    type="url" 
                    class="form-control" 
                    id="fhir_base_url"
                    formControlName="fhir_base_url"
                    [class.is-invalid]="configurationForm.get('fhir_base_url')?.invalid && configurationForm.get('fhir_base_url')?.touched"
                    placeholder="https://your-fhir-server.com/fhir">
                  <label for="fhir_base_url">FHIR Base URL <span class="text-danger">*</span></label>
                </div>
                <div *ngIf="configurationForm.get('fhir_base_url')?.invalid && configurationForm.get('fhir_base_url')?.touched" class="invalid-feedback">
                  Please enter a valid HTTP/HTTPS URL.
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-12">
                <label for="instructions" class="form-label mb-2">Instructions <span class="text-danger">*</span></label>
                <div class="row">
                  <!-- Editor Column -->
                  <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                      <small class="text-muted">
                        <i class="bi bi-pencil me-1"></i>
                        Editor
                      </small>
                    </div>
                    <div class="form-floating">
                      <textarea 
                        class="form-control" 
                        id="instructions"
                        formControlName="instructions"
                        [class.is-invalid]="configurationForm.get('instructions')?.invalid && configurationForm.get('instructions')?.touched"
                        style="height: 150px;"
                        placeholder="Enter user instructions in markdown format..."></textarea>
                      <label for="instructions">Instructions <span class="text-danger">*</span></label>
                    </div>
                    <div *ngIf="configurationForm.get('instructions')?.invalid && configurationForm.get('instructions')?.touched" class="invalid-feedback">
                      Instructions are required.
                    </div>
                    <div class="form-text">Use markdown format for rich text instructions.</div>
                  </div>
                  
                  <!-- Preview Column -->
                  <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                      <small class="text-muted">
                        <i class="bi bi-eye me-1"></i>
                        Preview
                      </small>
                    </div>
                    <div class="markdown-preview">
                      <div class="border rounded p-3 bg-light" style="min-height: 150px;">
                        <div *ngIf="configurationForm.get('instructions')?.value; else noInstructions">
                          <markdown [data]="configurationForm.get('instructions')?.value"></markdown>
                        </div>
                        <ng-template #noInstructions>
                          <div class="text-muted fst-italic">No instructions entered yet...</div>
                        </ng-template>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Data Files Section -->
            <div class="row mb-3">
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="text-muted mb-0">Data Files</h5>
                  <div class="d-flex gap-2">
                    <div class="dropdown">
                      <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-sort-down me-1"></i>
                        Sort
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" (click)="sortDataFiles('priority'); $event.preventDefault()">
                          <i class="bi bi-sort-numeric-down me-2"></i>By Priority
                        </a></li>
                        <li><a class="dropdown-item" href="#" (click)="sortDataFiles('name'); $event.preventDefault()">
                          <i class="bi bi-sort-alpha-down me-2"></i>By Name
                        </a></li>
                        <li><a class="dropdown-item" href="#" (click)="sortDataFiles('type'); $event.preventDefault()">
                          <i class="bi bi-sort-alpha-down me-2"></i>By Type
                        </a></li>
                      </ul>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" (click)="addDataFile()">
                      <i class="bi bi-plus me-1"></i>
                      Add File
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div formArrayName="data" 
                 (dragover)="onDragOver($event)" 
                 (drop)="onDrop($event)">
              <div *ngFor="let dataFile of dataFiles.controls; let i = index" 
                   class="border rounded p-4 mb-3 draggable-item"
                   [attr.data-index]="i"
                   draggable="true"
                   (dragstart)="onDragStart($event, i)"
                   (dragend)="onDragEnd($event)"
                   (dragover)="onItemDragOver($event, i)"
                   (drop)="onItemDrop($event, i)">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-grip-vertical text-muted me-2 drag-handle" style="cursor: move;"></i>
                    <h6 class="mb-0 text-muted">File {{ i + 1 }}</h6>
                  </div>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeDataFile(i)">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
                <div [formGroupName]="i">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <div class="form-floating">
                        <input 
                          type="text" 
                          class="form-control" 
                          [id]="'file_' + i"
                          formControlName="file"
                          [class.is-invalid]="dataFile.get('file')?.invalid && dataFile.get('file')?.touched"
                          placeholder="data/example/patient.json">
                        <label [for]="'file_' + i">File Path <span class="text-danger">*</span></label>
                      </div>
                      <div *ngIf="dataFile.get('file')?.invalid && dataFile.get('file')?.touched" class="invalid-feedback">
                        File path is required.
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-floating">
                        <input 
                          type="text" 
                          class="form-control" 
                          [id]="'name_' + i"
                          formControlName="name"
                          [class.is-invalid]="dataFile.get('name')?.invalid && dataFile.get('name')?.touched"
                          placeholder="Patient Data">
                        <label [for]="'name_' + i">Name <span class="text-danger">*</span></label>
                      </div>
                      <div *ngIf="dataFile.get('name')?.invalid && dataFile.get('name')?.touched" class="invalid-feedback">
                        Name is required.
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-floating">
                        <input 
                          type="number" 
                          class="form-control" 
                          [id]="'priority_' + i"
                          formControlName="priority"
                          [class.is-invalid]="dataFile.get('priority')?.invalid && dataFile.get('priority')?.touched"
                          min="1"
                          placeholder="1">
                        <label [for]="'priority_' + i">Priority</label>
                      </div>
                      <div *ngIf="dataFile.get('priority')?.invalid && dataFile.get('priority')?.touched" class="invalid-feedback">
                        Priority must be at least 1.
                      </div>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <div class="form-floating">
                        <textarea 
                          class="form-control" 
                          [id]="'description_' + i"
                          formControlName="description"
                          [class.is-invalid]="dataFile.get('description')?.invalid && dataFile.get('description')?.touched"
                          style="height: 80px;"
                          placeholder="Description of the data file..."></textarea>
                        <label [for]="'description_' + i">Description <span class="text-danger">*</span></label>
                      </div>
                      <div *ngIf="dataFile.get('description')?.invalid && dataFile.get('description')?.touched" class="invalid-feedback">
                        Description is required.
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-floating">
                        <input 
                          type="text" 
                          class="form-control" 
                          [id]="'type_' + i"
                          formControlName="type"
                          [class.is-invalid]="dataFile.get('type')?.invalid && dataFile.get('type')?.touched"
                          placeholder="Patient">
                        <label [for]="'type_' + i">Type <span class="text-danger">*</span></label>
                      </div>
                      <div *ngIf="dataFile.get('type')?.invalid && dataFile.get('type')?.touched" class="invalid-feedback">
                        Type is required.
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-floating">
                        <select 
                          class="form-select" 
                          [id]="'loader_' + i"
                          formControlName="loader"
                          [class.is-invalid]="dataFile.get('loader')?.invalid && dataFile.get('loader')?.touched"
                          (change)="onDataFileLoaderChange(i)">
                          <option value="" disabled>Select loader type</option>
                          <option [value]="LoaderType.FHIR_BUNDLE">FHIR Bundle</option>
                          <option [value]="LoaderType.CQL_AS_FHIR_LIBRARY">CQL as FHIR Library</option>
                        </select>
                        <label [for]="'loader_' + i">Loader Type <span class="text-danger">*</span></label>
                      </div>
                      <div *ngIf="dataFile.get('loader')?.invalid && dataFile.get('loader')?.touched" class="invalid-feedback">
                        Please select a loader type.
                      </div>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <div class="form-check">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          [id]="'load_' + i"
                          formControlName="load">
                        <label class="form-check-label" [for]="'load_' + i">
                          Load this file by default
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- CQL Evaluation Section (only for CQL libraries) -->
                  <div *ngIf="dataFile.get('loader')?.value === LoaderType.CQL_AS_FHIR_LIBRARY" class="mt-3">
                    <div class="border rounded p-3 bg-white">
                      <h6 class="mb-3 text-muted">CQL Evaluation</h6>
                      <div formGroupName="evaluate">
                        <div class="row mb-3">
                          <div class="col-md-6">
                            <div class="form-floating">
                              <input 
                                type="text" 
                                class="form-control" 
                                [id]="'evaluate_id_' + i"
                                formControlName="id"
                                [class.is-invalid]="dataFile.get('evaluate.id')?.invalid && dataFile.get('evaluate.id')?.touched"
                                placeholder="Library ID for evaluation">
                              <label [for]="'evaluate_id_' + i">Library ID <span class="text-danger">*</span></label>
                            </div>
                            <div *ngIf="dataFile.get('evaluate.id')?.invalid && dataFile.get('evaluate.id')?.touched" class="invalid-feedback">
                              Library ID is required for CQL libraries.
                            </div>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <label class="form-label mb-0">Subjects</label>
                              <button type="button" class="btn btn-outline-primary btn-sm" (click)="addSubject(dataFile.get('evaluate'))">
                                <i class="bi bi-plus me-1"></i>
                                Add
                              </button>
                            </div>
                            <div formArrayName="subjects">
                              <div *ngFor="let subject of getSubjectsArray(dataFile.get('evaluate'))?.controls || []; let j = index" class="row mb-2" [formGroupName]="j">
                                <div class="col-md-5">
                                  <div class="form-floating">
                                    <input 
                                      type="text" 
                                      class="form-control" 
                                      formControlName="id"
                                      [id]="'subject_id_' + i + '_' + j"
                                      placeholder="Subject ID">
                                    <label [for]="'subject_id_' + i + '_' + j">Subject ID</label>
                                  </div>
                                </div>
                                <div class="col-md-5">
                                  <div class="form-floating">
                                    <input 
                                      type="text" 
                                      class="form-control" 
                                      formControlName="name"
                                      [id]="'subject_name_' + i + '_' + j"
                                      placeholder="Subject Name">
                                    <label [for]="'subject_name_' + i + '_' + j">Subject Name</label>
                                  </div>
                                </div>
                                <div class="col-md-2">
                                  <button type="button" class="btn btn-outline-danger btn-sm w-100" (click)="removeSubject(dataFile.get('evaluate')!, j)">
                                    <i class="bi bi-trash"></i>
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Links Section -->
            <div class="row mb-3">
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="text-muted mb-0">Links</h5>
                  <button type="button" class="btn btn-outline-primary btn-sm" (click)="addLink()">
                    <i class="bi bi-plus me-1"></i>
                    Add Link
                  </button>
                </div>
              </div>
            </div>

            <div formArrayName="links">
              <div *ngFor="let link of links.controls; let i = index" class="border rounded p-3 mb-3 bg-light" [formGroupName]="i">
                <div class="row">
                  <div class="col-md-5">
                    <div class="form-floating">
                      <input 
                        type="text" 
                        class="form-control" 
                        [id]="'link_name_' + i"
                        formControlName="name"
                        [class.is-invalid]="link.get('name')?.invalid && link.get('name')?.touched"
                        placeholder="Documentation">
                      <label [for]="'link_name_' + i">Link Name <span class="text-danger">*</span></label>
                    </div>
                    <div *ngIf="link.get('name')?.invalid && link.get('name')?.touched" class="invalid-feedback">
                      Link name is required.
                    </div>
                  </div>
                  <div class="col-md-5">
                    <div class="form-floating">
                      <input 
                        type="url" 
                        class="form-control" 
                        [id]="'link_url_' + i"
                        formControlName="url"
                        [class.is-invalid]="link.get('url')?.invalid && link.get('url')?.touched"
                        placeholder="https://example.com">
                      <label [for]="'link_url_' + i">URL <span class="text-danger">*</span></label>
                    </div>
                    <div *ngIf="link.get('url')?.invalid && link.get('url')?.touched" class="invalid-feedback">
                      Please enter a valid HTTP/HTTPS URL.
                    </div>
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" (click)="removeLink(i)">
                      <i class="bi bi-trash me-1"></i>
                      Remove
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mt-4">
              <div class="col-12">
                <div class="d-flex justify-content-end gap-2">
                  <button type="button" class="btn btn-outline-secondary btn-sm" (click)="resetForm()">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Reset
                  </button>
                  <button type="submit" class="btn btn-success btn-sm">
                    <i class="bi bi-check me-1"></i>
                    Apply
                  </button>
                  <button type="button" class="btn btn-outline-primary btn-sm" (click)="downloadConfiguration()">
                    <i class="bi bi-download me-1"></i>
                    Download
                  </button>
                </div>
              </div>
            </div>
          </form>
    </div>
  </div>
</div>
